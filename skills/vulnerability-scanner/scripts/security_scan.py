#!/usr/bin/env python3
"""
Skill: vulnerability-scanner
Script: security_scan.py
Purpose: Run security vulnerability scans (npm audit, secret detection)
Usage: python security_scan.py [project_path]
Output: JSON with vulnerability findings
"""
import subprocess
import json
import os
import sys
import re

def run_npm_audit(project_path: str) -> dict:
    """Run npm audit for dependency vulnerabilities."""
    try:
        result = subprocess.run(
            ["npm", "audit", "--json"],
            cwd=project_path,
            capture_output=True,
            text=True,
            timeout=60
        )
        
        try:
            audit_data = json.loads(result.stdout)
            vulnerabilities = audit_data.get("vulnerabilities", {})
            
            summary = {
                "critical": 0,
                "high": 0,
                "moderate": 0,
                "low": 0
            }
            
            for vuln in vulnerabilities.values():
                severity = vuln.get("severity", "low").lower()
                if severity in summary:
                    summary[severity] += 1
            
            return {
                "tool": "npm_audit",
                "total": sum(summary.values()),
                "by_severity": summary,
                "status": "ðŸ”´ Critical issues" if summary["critical"] > 0 else 
                         ("ðŸŸ¡ Has vulnerabilities" if sum(summary.values()) > 0 else "ðŸŸ¢ No vulnerabilities")
            }
        except json.JSONDecodeError:
            return {"tool": "npm_audit", "error": "Failed to parse audit output"}
            
    except FileNotFoundError:
        return {"tool": "npm_audit", "error": "npm not found"}
    except subprocess.TimeoutExpired:
        return {"tool": "npm_audit", "error": "Audit timed out"}

def scan_for_secrets(project_path: str) -> dict:
    """Scan for hardcoded secrets in code."""
    patterns = [
        (r'api[_-]?key\s*[=:]\s*["\'][^"\']+["\']', "API Key"),
        (r'password\s*[=:]\s*["\'][^"\']+["\']', "Password"),
        (r'secret\s*[=:]\s*["\'][^"\']+["\']', "Secret"),
        (r'token\s*[=:]\s*["\'][^"\']+["\']', "Token"),
        (r'private[_-]?key\s*[=:]\s*["\'][^"\']+["\']', "Private Key"),
    ]
    
    findings = []
    extensions = ('.js', '.ts', '.jsx', '.tsx', '.py', '.env.local', '.env.development')
    
    for root, dirs, files in os.walk(project_path):
        # Skip node_modules and .git
        dirs[:] = [d for d in dirs if d not in ('node_modules', '.git', 'dist', 'build')]
        
        for file in files:
            if file.endswith(extensions):
                filepath = os.path.join(root, file)
                try:
                    with open(filepath, 'r', encoding='utf-8', errors='ignore') as f:
                        content = f.read()
                        for pattern, secret_type in patterns:
                            matches = re.findall(pattern, content, re.IGNORECASE)
                            if matches:
                                findings.append({
                                    "file": os.path.relpath(filepath, project_path),
                                    "type": secret_type,
                                    "count": len(matches)
                                })
                except Exception:
                    pass
    
    return {
        "tool": "secret_scanner",
        "findings": findings[:10],  # Limit to first 10
        "total": len(findings),
        "status": "ðŸ”´ Secrets found!" if findings else "ðŸŸ¢ No secrets detected"
    }

def run_security_scan(project_path: str) -> dict:
    """Run all security scans."""
    return {
        "project": project_path,
        "scans": {
            "dependencies": run_npm_audit(project_path),
            "secrets": scan_for_secrets(project_path)
        }
    }

if __name__ == "__main__":
    project_path = sys.argv[1] if len(sys.argv) > 1 else "."
    result = run_security_scan(project_path)
    print(json.dumps(result, indent=2))
